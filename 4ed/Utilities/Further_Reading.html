
<!doctype html>
<html lang="en">
<head>

<!-- all praise to https://realfavicongenerator.net -->
<link rel="icon" href="/favicon.ico?v=2" /> <!-- force refresh -->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="/fonts.css">
  <link rel="stylesheet" href="../pbrstyle.css">
  <link rel="stylesheet" href="/fontawesome-free-5.15.3-web/css/all.css">

<script async src="https://cse.google.com/cse.js?cx=22a43cef261a245ea"></script>  <script src="/react.min.js"></script>
  <script src="/react-dom.min.js"></script>
  <script src="/jeri.min.js"></script>
  <link rel="preload" href="/exr.worker.js" as="script" crossorigin="anonymous">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/bootstrap.min.css">

  <title>Further Reading</title>
</head>
        
<body>

<nav class="fixed-top-lg-navbar navbar navbar-expand bg-light navbar-light">
  <ul class="nav navbar-nav">
    <a class="navbar-brand" href="../contents.html"><img src="../pbr.jpg" width=25 height=25></a>
    <li class="nav-item"><a class="nav-link" href="../Utilities.html">Utilities</a></li>
    <span class="navbar-text">/</span>
    <li class="nav-item"><a class="nav-link" href="#">Further Reading</a></li>
    <span class="navbar-text">&nbsp;&nbsp;</span>
    <li class="nav-item"><a class="nav-link" href="../Utilities/Statistics.html">(Previous: Statistics)</a></li>
  </ul>

  <ul class="nav navbar-nav ml-auto d-none d-md-block">
        <li class="nav-item"><div class="gcse-search"></div></li>
    </ul>
  <ul class="nav navbar-nav d-block d-md-none">
        <li class="nav-item"><div class="gcse-search"></div></li>
    </ul>
</nav>

<div class="maincontainer">
<div class="container-fluid">

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">

</div>
<div class="col-md-10 col-lg-8">

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

<div class="row">
<div class="col-md-1 col-lg-2 leftcolumn">
<a href="#"><i class="fas fa-link "></i></a>
</div>
<div class="col-md-10 col-lg-8">
<h2>Further Reading</h2><p>


</p>
<p><em>Hacker&rsquo;s Delight</em> (Warren&nbsp;<a href="#cite:HackersDelight">2006</a>) is a delightful
and thought-provoking exploration of bit-twiddling algorithms like
those used in some of the utility routines in this appendix.  Sean Anderson
(<a href="#cite:Anderson2004">2004</a>) has a Web page filled with a collection of
bit-twiddling techniques like the ones in <a href="../Utilities/Mathematical_Infrastructure.html#IsPowerOf2"><tt>IsPowerOf2()</tt></a> and
<a href="../Utilities/Mathematical_Infrastructure.html#RoundUpPow2"><tt>RoundUpPow2()</tt></a> at <a href="http://graphics.stanford.edu/~seander/bithacks.html">graphics.stanford.edu/~seander/bithacks.html</a>.

</p>
<p>The MurmurHash hashing function that is wrapped by <tt>pbrt</tt>&rsquo;s <a href="../Utilities/Mathematical_Infrastructure.html#Hash"><tt>Hash()</tt></a> and
<a href="../Utilities/Mathematical_Infrastructure.html#HashBuffer"><tt>HashBuffer()</tt></a> functions is due to Appleby (<a href="#cite:Appleby2011">2011</a>) and
the implementation of <a href="../Utilities/Mathematical_Infrastructure.html#MixBits"><tt>MixBits()</tt></a> is due to Stafford
(<a href="#cite:Stafford2011">2011</a>), who found the various constant values used in
the implementation via search.

</p>
<p>The inverse bilinear interpolation function implemented in
<a href="../Utilities/Mathematical_Infrastructure.html#InvertBilinear"><tt>InvertBilinear()</tt></a> is due to Quilez (<a href="#cite:Quilez2010">2010</a>) and
<a href="../Utilities/Mathematical_Infrastructure.html#SinXOverX"><tt>SinXOverX()</tt></a> is thanks to Hatch (<a href="#cite:Hatch2003">2003</a>).

</p>
<p>The algorithm implemented in <a href="../Utilities/Mathematical_Infrastructure.html#TwoSum"><tt>TwoSum()</tt></a> is due to
M&oslash;ller&nbsp;(<a href="#cite:Moller65">1965</a>) and Knuth&nbsp;(<a href="#cite:Knuth69">1969</a>), and the
FMA-based <a href="../Utilities/Mathematical_Infrastructure.html#TwoProd"><tt>TwoProd()</tt></a> was developed by Ogita et al.&nbsp;(<a href="#cite:Ogita2005">2005</a>).
The approach used in the <a href="../Utilities/Mathematical_Infrastructure.html#CompensatedSum"><tt>CompensatedSum</tt></a> class is due to Kahan
(<a href="#cite:Kahan1965">1965</a>).  The approach used in <a href="../Utilities/Mathematical_Infrastructure.html#DifferenceOfProducts"><tt>DifferenceOfProducts()</tt></a>
is also attributed to Kahan; its error was analyzed by Jeannerod et
al. (<a href="#cite:Jeannerod2013">2013</a>).

</p>
<p>Welford (<a href="#cite:Welford62">1962</a>) developed the algorithm that is implemented
in the <a href="../Utilities/Mathematical_Infrastructure.html#VarianceEstimator"><tt>VarianceEstimator</tt></a> class.  Its <tt>Merge()</tt> method is based
on an algorithm developed by Chan et al. (<a href="#cite:Chan79">1979</a>).  

</p>
<p>Atkinson&rsquo;s book (<a href="#cite:Atkinson1993">1993</a>) on numerical analysis 
discusses algorithms for matrix inversion and solving linear systems.
See Moore&rsquo;s book (<a href="#cite:Moore66">1966</a>) for an introduction to interval
arithmetic.

</p>
<p>Farin&rsquo;s book (<a href="#cite:Farin2001">2001</a>) is a good introduction to splines.
The blossoming approach was introduced by Ramshaw&nbsp;(<a href="#cite:Ramshaw1987">1987</a>);
his report remains a readable introduction to the topic.  A subsequent
publication drew further connections to polar forms and related
work&nbsp;(<a href="#cite:Ramshaw1989">Ramshaw 1989</a>).

</p>
<p>The PCG random number generator was developed by O&rsquo;Neill
(<a href="#cite:ONeill2014">2014</a>). The paper describing its implementation is well
written and also features extensive discussion of a range of previous
pseudo-random number generators and the challenges that they have faced in
passing rigorous tests of their quality (L&rsquo;Ecuyer and
Simard&nbsp;<a href="#cite:LEcuyer2007">2007</a>).

</p>
<p>The article &ldquo;UTF-8 Everywhere&rdquo; by Radzivilovsky et
al.&nbsp;(<a href="#cite:Radzivilovsky2012">2012</a>) is a good introduction to Unicode
and also makes a strong case for adopting the UTF-8 representation.  <tt>pbrt</tt> follows the approach they propose for interoperating with Windows&rsquo;s
UTF-16-based APIs.  At over 1,000 pages, the length of the official Unicode
specification gives some sense of the complexities in representing
multi-lingual text&nbsp;(<a href="#cite:Unicode2020">Unicode Consortium 2020</a>).

</p>
<p>Gamma correction has a long history in computer graphics. Poynton
(<a href="#cite:Poynton02color">2002a</a>, <a href="#cite:Poynton02">2002b</a>) has written comprehensive
FAQs on issues related to color representation and gamma correction.  The
sRGB encoding was described by the International Electrotechnical Commission
(<a href="#cite:IEC1999">1999</a>).  See Gritz and d&rsquo;Eon
(<a href="#cite:Gritz08">2008</a>) for a detailed discussion of the implications of gamma
correction for rendering and how to correctly account for it in rendering
systems.

</p>
<p>McKenney&rsquo;s book on parallel programming is wonderfully written and has
comprehensive coverage of the underlying issues, as well as many useful
techniques for high-performance parallel programming on CPUs
(<a href="#cite:McKenney2021">2021</a>).  Drepper&rsquo;s paper (<a href="#cite:Drepper07">2007</a>) is a
useful resource for understanding performance issues related to caches,
cache coherence, and main memory access, particularly in multicore systems.

</p>
<p>Boehm&rsquo;s paper &ldquo;Threads Cannot Be Implemented as a Library&rdquo;
(<a href="#cite:Boehm05">2005</a>) makes the remarkable (and disconcerting) observation
that multi-threading cannot be reliably implemented without the compiler
having explicit knowledge of the fact that multi-threaded execution is
expected.  Boehm presented a number of examples that demonstrate the
corresponding dangers in 2005-era compilers and language standards like C
and C++ that did not have awareness of threading.  Fortunately, the C++11
and C11 standards addressed the issues that he identified.

</p>
<p><tt>pbrt</tt>&rsquo;s parallel <tt>for</tt> loop&ndash;based approach to multi-threading is a
widely used technique for multi-threaded programming; the OpenMP standard
supports a similar construct (and much more) (OpenMP Architecture Review
Board&nbsp;<a href="#cite:OpenMP13">2013</a>).  A slightly more general model for multi-core
parallelism is available from <em>task systems</em>, where computations are
broken up into a set of independent tasks that can be executed
concurrently.  That model is supported through <a href="../Utilities/Parallelism.html#RunAsync"><tt>RunAsync()</tt></a>.
Blumofe et&nbsp;al. (<a href="#cite:Blumofe96">1996</a>) described the task
scheduler in Cilk, and Blumofe and Leiserson (<a href="#cite:Blumofe99">1999</a>)
described the work-stealing algorithm that is the mainstay of many current
high-performance task systems.

</p>
<p></p>
<h3>References</h3>
<ol style="list-style: none;">
<li class="bibitem" id="cite:Anderson2004">Anderson, S. 2004. Bit twiddling hacks. <a href="http://graphics.stanford.edu/&nbsp;seander/bithacks.html">graphics.stanford.edu/&nbsp;seander/bithacks.html</a>.
</li>

<li class="bibitem" id="cite:Appleby2011">Appleby, A. 2011.
MurmurHash3.
<a href="https://sites.google.com/site/murmurhash/">https://sites.google.com/site/murmurhash/</a>.
</li>

<li class="bibitem" id="cite:Atkinson1993">Atkinson, K. 1993.
<em>Elementary Numerical Analysis.</em> New York: John Wiley &amp; Sons.
</li>

<li class="bibitem" id="cite:Blumofe99">Blumofe, R., and C.&nbsp;Leiserson. 1999.
Scheduling multithreaded computations by work stealing.
<em>Journal of the ACM</em>&nbsp;<em>46</em>&thinsp;(5), 720&ndash;48.
</li>

<li class="bibitem" id="cite:Blumofe96">Blumofe, R., C.&nbsp;Joerg, B.&nbsp;Kuszmaul, C.&nbsp;Leiserson, K.&nbsp;Randall, and
 Y.&nbsp;Zhou. 1996.
Cilk: An efficient multithreaded runtime system.
<em>Journal of Parallel and Distributed Computing</em>&nbsp;<em>37</em>&thinsp;(1),
55&ndash;69.
</li>

<li class="bibitem" id="cite:Boehm05">Boehm, H.-J. 2005.
Threads cannot be implemented as a library.
<em>ACM SIGPLAN Notices</em> <em>40</em>&thinsp;(6), 261&ndash;68.
</li>

<li class="bibitem" id="cite:Chan79">Chan, T.&nbsp;F., G.&nbsp;Golub, R.&nbsp;J.&nbsp;LeVeque. 1979.
Updating formulae and a pairwise algorithm for computing sample variances.
<em>Technical Report STAN-CS-79-773</em>, Department of Computer Science,
Stanford University.
</li>

<li class="bibitem" id="cite:Drepper07">Drepper, U. 2007.
What every programmer should know about memory.
<a href="http://people.redhat.com/drepper/cpumemory.pdf">people.redhat.com/drepper/cpumemory.pdf</a>.
</li>

<li class="bibitem" id="cite:Farin2001">Farin, G. 2001.
<em>Curves and Surfaces for CAGD: A Practical Guide</em> (5th ed.).
San Francisco: Morgan Kaufmann.
</li>

<li class="bibitem" id="cite:Gritz08">Gritz, L., and E.&nbsp;d&rsquo;Eon. 2008.
The importance of being linear.
In H.&nbsp;Nguyen (ed.), <em>GPU Gems 3</em>, 529&ndash;42.
Boston, Massachusetts: Addison-Wesley.
</li>

<li class="bibitem" id="cite:Guthe05">Guthe, S., and P.&nbsp;Heckbert 2005.
Non-power-of-two Mipmap creation.
<em>NVIDIA Technical Report</em>.
</li>

<li class="bibitem" id="cite:Hatch2003">Hatch, D. 2003.
The right way to calculate stuff.
<a href="http://www.plunk.org/&nbsp;hatch/rightway.html">http://www.plunk.org/&nbsp;hatch/rightway.html</a>.
</li>

<li class="bibitem" id="cite:IEC1999">International Electrotechnical Commission (IEC). 1999.
Multimedia systems and equipment&mdash;Colour measurement and management&mdash;Part
2-1: Colour management&mdash;Default RGB colour space&mdash;sRGB.
IEC Standard 61966-2-1.
</li>

<li class="bibitem" id="cite:Jeannerod2013">Jeannerod, C.-P., N.&nbsp;Louvet, and J.-M.&nbsp;Muller. 2013.
Further analysis of Kahan&rsquo;s algorithm for the accurate computation of <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.165ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2223.9 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">2 times 2</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-LATINMODERNMAIN-32" d="M449 174l-28 -174h-371c0 24 0 26 11 37l192 214c55 62 105 141 105 221c0 82 -43 163 -134 163c-58 0 -112 -37 -135 -102c3 1 5 1 13 1c35 0 53 -26 53 -52c0 -41 -35 -53 -52 -53c-3 0 -53 0 -53 56c0 89 74 181 187 181c122 0 212 -80 212 -194 c0 -100 -60 -154 -216 -292l-106 -103h180c22 0 88 0 95 8c10 15 17 59 22 89h25Z"></path>
<path stroke-width="1" id="E1-LATINMODERNMAIN-D7" d="M624 15c-7 -8 -20 -8 -28 0l-207 207l-207 -207c-8 -8 -21 -8 -28 0c-8 7 -8 20 0 28l207 207l-207 207c-8 8 -8 21 0 28c7 8 20 8 28 0l207 -207l207 207c8 8 21 8 28 0c8 -7 8 -20 0 -28l-207 -207l207 -207c8 -8 8 -21 0 -28Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-LATINMODERNMAIN-32" x="0" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-D7" x="722" y="0"></use>
 <use xlink:href="#E1-LATINMODERNMAIN-32" x="1723" y="0"></use>
</g>
</svg> determinants.
<em>Mathematics of Computation</em>&nbsp;<em>82</em>&thinsp;(284), 2245&ndash;64.
</li>

<li class="bibitem" id="cite:Kahan1965">Kahan, W. 1965.
Further remarks on reducing truncation errors.
<em>Communications of the ACM</em>&nbsp;<em>8</em>&thinsp;(1), 40.
</li>

<li class="bibitem" id="cite:Kainz04">Kainz, F., R.&nbsp;Bogart, and D.&nbsp;Hess. 2004.
The OpenEXR File Format.
In R. Fernando (ed.), <em>GPU Gems</em>, 425&ndash;44.
Reading, Massachusetts: Addison-Wesley.
</li>

<li class="bibitem" id="cite:Knuth69">Knuth, D.&nbsp;E. 1969.
<em>The Art of Computer Programming: Seminumerical Algorithms</em>.
Reading, Massachusetts: Addison-Wesley.
</li>

<li class="bibitem" id="cite:LEcuyer2007">L&rsquo;Ecuyer, P., and R.&nbsp;Simard. 2007.
TestU01: A C library for empirical testing of random number
generators.
<em>ACM Transactions on Mathematical Software</em>&nbsp;<em>33</em>&thinsp;(4), 22:1&ndash;40.
</li>

<li class="bibitem" id="cite:Moller65">M&oslash;ller, O. 1965.
Quasi double precision in floating-point arithmetic.
<em>BIT Numerical Mathematics</em>&nbsp;<em>5</em>, 37&ndash;50.
</li>

<li class="bibitem" id="cite:McKenney2021">McKenney, P.&nbsp;E. 2021.
<em>Is Parallel Programming Hard, and, If So, What Can You Do About It?</em>
<a href="https://mirrors.edge.kernel.org/pub/linux/kernel/people/paulmck/perfbook/perfbook.html">https://mirrors.edge.kernel.org/pub/linux/kernel/people/paulmck/perfbook/perfbook.html</a>.
</li>

<li class="bibitem" id="cite:Moore66">Moore, R.&nbsp;E. 1966.
<em>Interval Analysis</em>.
Englewood Cliffs, New Jersey: Prentice Hall.
</li>

<li class="bibitem" id="cite:ONeill2014">O&rsquo;Neill, M. 2014.
PCG: A family of simple fast space-efficient statistically good algorithms
for random number generation.
Unpublished manuscript. <a href="http://www.pcg-random.org/paper.html">http://www.pcg-random.org/paper.html</a>.
</li>

<li class="bibitem" id="cite:Ogita2005">Ogita, T., S.&nbsp;M.&nbsp;Rump, and S.&nbsp;Oishi. 2005.
Accurate sum and dot product.
<em>SIAM Journal on Scientific Computing</em>&nbsp;<em>26</em>&thinsp;(6), 1955&ndash;88.
</li>

<li class="bibitem" id="cite:OpenMP13">OpenMP Architecture Review Board. 2013.
OpenMP Application Program Interface.
<a href="http://www.openmp.org/mp-documents/OpenMP4.0.0.pdf">http://www.openmp.org/mp-documents/OpenMP4.0.0.pdf</a>.
</li>

<li class="bibitem" id="cite:Poynton02color">Poynton, C. 2002a.
Frequently-asked questions about color.
<a href="http://www.poynton.com/ColorFAQ.html">www.poynton.com/ColorFAQ.html</a>.
</li>

<li class="bibitem" id="cite:Poynton02">Poynton, C. 2002b.
Frequently-asked questions about gamma.
<a href="http://www.poynton.com/GammaFAQ.html">www.poynton.com/GammaFAQ.html</a>.
</li>

<li class="bibitem" id="cite:Quilez2010">Quilez, I. 2010.
Inverse bilinear interpolation.
<a href="https://www.iquilezles.org/www/articles/ibilinear/ibilinear.htm">https://www.iquilezles.org/www/articles/ibilinear/ibilinear.htm</a>.
</li>

<li class="bibitem" id="cite:Radzivilovsky2012">Radzivilovsky, P., Y.&nbsp;Galka, and S.&nbsp;Novgorodov. 2012.
UTF-8 everywhere.
<a href="http://utf8everywhere.org">http://utf8everywhere.org</a>.
</li>

<li class="bibitem" id="cite:Ramshaw1987">Ramshaw, L. 1987.
Blossoming: A connect-the-dots approach to splines.
<em>Digital Systems Research Center Technical Report</em>.
</li>

<li class="bibitem" id="cite:Ramshaw1989">Ramshaw, R. 1989.
Blossoms are polar forms.
<em>Computer Aided Geometric Design</em>&nbsp;<em>6</em>&thinsp;(4), 323&ndash;58.
</li>

<li class="bibitem" id="cite:Stafford2011">Stafford, D. 2011.
Better bit mixing&mdash;improving on MurmurHash3&rsquo;s 64-bit finalizer.
<a href="http://zimbry.blogspot.com/2011/09/better-bit-mixing-improving-on.html">http://zimbry.blogspot.com/2011/09/better-bit-mixing-improving-on.html</a>.
</li>

<li class="bibitem" id="cite:Unicode2020">Unicode Consortium. 2020.
The Unicode Standard: Version 13.0.
<a href="https://www.unicode.org/versions/Unicode13.0.0/UnicodeStandard-13.0.pdf">https://www.unicode.org/versions/Unicode13.0.0/UnicodeStandard-13.0.pdf</a>.
</li>

<li class="bibitem" id="cite:HackersDelight">Warren, H. 2006.
<em>Hacker&rsquo;s Delight</em>.
Reading, Massachusetts: Addison-Wesley.
</li>

<li class="bibitem" id="cite:Welford62">Welford, B.&nbsp;P. 1962.
Note on a method for calculating corrected sums of squares and products.
<em>Technometrics</em>&nbsp;<em>4</em>&thinsp;(3), 419&ndash;20.
</li>

</ol>
<p>


</p>
<p>

</p>
<p></p>

</div> <!-- col-md-10 col-lg-8 -->
<div class="col-md-1 col-lg-2">

</div> <!-- col-md-1 col-lg-2 -->
</div>  <!-- row -->

</div>  <!-- container-fluid -->
</div>  <!-- maincontainer -->

<nav class="navbar navbar-expand-md bg-light navbar-light">
<div class="container-fluid">
  <span class="navbar-text"><i>Physically Based Rendering: From Theory To Implementation</i>,<br>
<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/">&copy; 2004-2023</a> Matt Pharr, Wenzel Jakob, and Greg Humphreys.
<a href="https://github.com/mmp/pbr-book-website/"><span class="fab fa-github"></span></a><br>
Purchase a printed copy: <a href="https://www.amazon.com/Physically-Based-Rendering-fourth-Implementation/dp/0262048027?keywords=physically+based+rendering+4th+edition&qid=1671730412&sprefix=physically+based%!C(MISSING)aps%!C(MISSING)145&sr=8-1&linkCode=ll1&tag=pharr-20&linkId=81a816d90f0c7e872617f1f930a51fd6&language=en_US&ref_=as_li_ss_tl"><span class="fab fa-amazon"></span></a>
<a href="https://mitpress.mit.edu/9780262048026/physically-based-rendering/"><img src="/mitpress.png" width=10 height=16></a>
</span>
</div>
  <div class="container">
    <ul class="nav navbar-nav ml-auto">
      <li class="nav-item">Next: <a href="../Utilities/Exercises.html">Utilities / Exercises</a></li>
    </ul>
  </div>

</nav>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script>
  $(function () {
    $('[data-toggle="popover"]').popover()
    $('[data-toggle="tooltip"]').tooltip()
   })
</script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

<script>
// https://stackoverflow.com/a/17535094
// The function actually applying the offset
function offsetAnchor() {
  if (location.hash.length !== 0) {
    window.scrollTo(window.scrollX, window.scrollY - window.innerHeight / 8);
  }
}

// Captures click events of all <a> elements with href starting with #
$(document).on('click', 'a[href^="#"]', function(event) {
  // Click events are captured before hashchanges. Timeout
  // causes offsetAnchor to be called after the page jump.
  window.setTimeout(function() {
    offsetAnchor();
  }, 500);
});

// Set the offset when entering page with hash present in the url
window.setTimeout(offsetAnchor, 1500);
</script>

</body>
</html>
